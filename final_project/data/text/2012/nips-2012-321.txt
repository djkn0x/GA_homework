OnlineSum-ProductComputationoverTreesMarkHerbsterStephenPasterisDepartmentofComputerScienceUniversityCollegeLondonLondonWC1E6BT,England,UK{m.herbster,s.pasteris}@cs.ucl.ac.ukFabioVitaleDepartmentofComputerScienceUniversityofMilan20135Milan,Italyfabio.vitale@unimi.itAbstractWeconsidertheproblemofperformingefﬁcientsum-productcomputationsinanonlinesettingoveratree.Anaturalapplicationofourmethodsistocomputethemarginaldistributionatavertexinatree-structuredMarkovrandomﬁeld.Beliefpropagationcanbeusedtosolvethisproblem,butrequirestimelinearinthesizeofthetree,andisthereforetooslowinanonlinesettingwherewearecontinuouslyreceivingnewdataandcomputingindividualmarginals.Withourmethodweaimtoupdatethedataandcomputemarginalsintimethatisnomorethanlogarithmicinthesizeofthetree,andisoftensigniﬁcantlyless.Weaccomplishthisviaahierarchicalcoveringstructurethatcachespreviouslocalsum-productcomputations.Ourcontributionisthree-fold:wei)givealineartimealgorithmtoﬁndanoptimalhierarchicalcoverofatree;ii)giveasum-product-likealgorithmtoefﬁcientlycomputemarginalswithrespecttothiscover;andiii)apply“i”and“ii”toﬁndanefﬁcientalgorithmwitharegretboundfortheonlineallocationprobleminamulti-tasksetting.1IntroductionTheuseofgraphicalmodels[1,2]isubiquitousinmachinelearning.Theapplicationofthebatchsum-productalgorithmtotree-structuredgraphicalmodels,includinghiddenMarkovmod-els,Kalmanﬁlteringandturbodecoding,issurveyedin[3].Ouraimistoadaptthesetechniquestoanonlinesetting.Inouronlinemodelwearegivenatreeandaﬁxedsetofparameters.Wethenreceiveapoten-tiallyunboundedonlinesequenceof“predictionrequests”and“dataupdates.”Apredictionrequestindicatesavertexforwhichwethenreturntheposteriormarginalatthatvertex.Eachdataupdateassociatesanew“factor”tothatvertex.Classicalbeliefpropagationrequirestimelinearinthesizeofthetreeforthistask.Ouralgorithmrequirestimelinearintheheightofanoptimalhierarchi-calcoverofthistree.Theheightofthecoverisintheworstcaselogarithmicinthesizethetree.Thusourpertrialprediction/updatetimeisatleastanexponentialimprovementoverclassicalbeliefpropagation.Thepaperisstructuredasfollows.InSection2weintroduceournotationleadingtoourdeﬁnitionofanoptimalhierarchicalcover.InSection3wegiveouroptimalhierarchicalcoveringalgorithm.InSection4weshowhowwemayusethiscoverasastructuretocachecomputationsinoursum-product-likealgorithm.Finally,inSection5wegivearegretboundandasketchofanapplicationofourtechniquestoanonlinemulti-taskallocation[4]problem.Previouswork.Pearl[5]introducedbeliefpropagationforBayesnetswhichcomputesmarginalsintimelinearinthesizeofthetree.In[6]analgorithmfortheonlinesettingwasgivenforaBayesnetonatreeTwhichrequiredO(log|V(T)|)timepermarginalizationstep,where|V(T)|isthenumberofverticesinthetree.InthisworkweconsideraMarkovrandomﬁeldonatree.WegiveanalgorithmwhoseperformanceisboundedbyO(χ∗(T)).Thetermχ∗(T)istheheightofour1optimalhierarchicalcoverwhichisupperboundedbyO(min(log|V(T)|,diameter(T))),butmayinfactbeexponentiallysmaller.2HierarchicalcoverofatreeInthissectionweintroduceournotionofahierarchicalcoverofatreeanditsdualthedecompo-sitiontree.Graph-theoreticalpreliminaries.AgraphGisapairofsets(V,E)suchthatEisasetofunorderedpairsofdistinctelementsfromV.TheelementsofVarecalledverticesandthoseofEarecallededges.Inordertoavoidambiguitiesderivingfromdealingwithdifferentgraphs,insomecaseswewillhighlightthemembershiptographGdenotingthesesetsasV(G)andE(G)respectively.Withslightabuseofnotation,bywritingv∈G,wemeanv∈V(G).SisasubgraphG(wewriteS⊆G)iffV(S)⊆V(G)andE(S)={(i,j):i,j∈V(S),(i,j)∈E(G)}.GivenanysubgraphS⊆G,wedeﬁneitsboundary(orinnerborder)∂G(S)anditsneighbourhood(orouterborder)NG(S)as:∂G(S):={i:i∈S,j/∈S,(i,j)∈E(G)},andNG(S):={j:i∈S,j/∈S,(i,j)∈E(G)}.Withslightabuseofnotation,NG(v):=NG({v}),andthusthedegreeofavertexvis|NG(v)|.GivenanygraphG,wedeﬁnethesetofitsleavesasleaves(G):={i∈G:|NG(i)|=1},anditsinteriorG•:={i∈G:|NG(i)|#=1}.ApathPinagraphGisdeﬁnedbyasequenceofdistinctvertices$v1,v2,...,vm%ofG,suchthatforalli<mwehavethat(vi,vi+1)∈E(G).Inthiscasewesaythatv1andvmareconnectedbythesubgraphP.AtreeTisagraphinwhichforallv,w∈Tthereexistsauniquepathconnectingvwithw.Inthispaperwewillonlyconsidertreeswithanon-emptyedgesetandthusthevertexsetwillalwayshaveacardinalityofatleast2.ThedistancedT(v,w)betweenv,w∈Tisthepathlength|E(P)|.Thepair(T,r)denotesarootedtreeTwithrootvertexr.Givenarootedtree(T,r)andanyvertexi∈V(T),the(proper)descendantsofiareallverticesthatcanbeconnectedwithrviapathsP⊆Tcontainingi(excludingi).Analogously,the(proper)ancestorsofiareallverticesthatlieonthepathP⊆Tconnectingiwithr(excludingi).Wedenotethesetofalldescendants(resp.allancestors)ofiby⇓rT(i)(resp.⇑rT(i)).Weshallomittherootrwhenitisclearfromthecontext.Vertexiistheparent(resp.child)ofj,whichisdenotedby↑rT(j)(resp.i∈↓rT(j))if(i,j)∈E(T)andi∈⇑rT(j)(resp.i∈⇓rT(j)).GivenatreeTweusethenotationS⊆TonlyifSisatreeandsubgraphofT.Theheightofarootedtree(T,r)isthemaximumlengthofapathP⊆Tconnectingtheroottoanyvertex:hr(T):=maxv∈TdT(v,r).Thediameter∆(T)ofatreeTisdeﬁnedasthelengthofthelongestpathbetweenanytwoverticesinT.2.1ThehierarchicalcoverofatreeInthissectionwedescribeasplittingprocessthatrecursivelydecomposesagiventreeT.A(de-composition)tree(D,r)identiﬁesthissplittingprocess,generatingatree-structuredcollectionSofsubtreesthathierarchicallycoverthegiventreeT.ThisprocessrecursivelysplitsateachstepasubtreeofT(thatwecalla“component”)resultingfromsomeprevioussplits.Moreprecisely,asubtreeS⊆TissplitintotwoormoresubcomponentsandthedecompositionofSdependsonlyonthechoiceofavertexv∈S•,whichwecallsplittingvertex,inthefollowingway.Thesplittingvertexv∈S•ofSinducesthesplitsetΩ(S,v)={S1,...,S|NS(v)|}whichistheuniquesetofS’ssubtreeswhichoverlapatavertexv,uniquely,thatrepresentacoverforS,i.e.,itsatisﬁes(i)∪S!∈Ω(S,v)S#=Sand(ii){v}=Si∩Sjforall1≤i<j≤|NS(v)|.ThusthesplitmaybevisualizedbyconsideringtheforestFresultingfromremovingavertexfromS,butafterwardseachcomponentS1,...,S|NS(v)|ofFhasthe“removedvertex”vaddedbacktoit.Acomponenthavingonlytwoverticesiscalledatomic,sinceitcannotbesplitfurther.WeindicatewithSv⊆Tthecomponentsubtreewhosesplittingvertexisv,andwedenoteatomiccomponentsbyS(i,j),whereE(S(i,j))={(i,j)}.WeﬁnallydenotebySthesetofallcomponentsubtreesobtainedbythissplittingprocess.Sincethemethodisrecursive,wecanassociatearootedtree(D,r),withT’sdecompositionintoahierarchicalcover,whoseinternalverticesarethesplittingverticesofthesplittingprocess.Itsleavescorrespondtothesingleedges(ofE(T))ofeachatomiccomponent,andavertex“parent-child”relationc∈↓rD(p)correspondstothe“splits-into”relationSc∈Ω(Sp,p)(seeFigure1).WewillnowformalizethesplittingprocessbydeﬁningthehierarchicalcoverSofatreeT,whichisakeyconceptusedbyouralgorithm.2Deﬁnition1.AhierarchicalcoverSofatreeTisatree-structuredcollectionofsubtreesthathierarchicallycoverthetreeTsatisfyingthefollowingthreeproperties:1.T∈S,2.forallS∈SwithS•#=∅thereexistsanx∈S•suchthatΩ(S,x)⊂S,3.forallS,R∈SsuchthatS#⊆RandR#⊆S,wehave|V(R)∩V(S)|≤1.Theabovedeﬁnitionrecursivelygeneratesacover.ThesplittingprocessthatgeneratesahierarchicalcoverSofTisformalizedasrootedtree(D,r)inthefollowingdeﬁnition.Deﬁnition2.IfSisahierarchicalcoverofTwedeﬁnetheassociateddecompositiontree(D,r)asarootedtree,whosevertexsetV(D):=T•∪E(T)whereD•=T•andleaves(D)=E(T),suchthatthefollowingthreepropertieshold:1.Sr=T,2.forallc,p∈D•,c∈↓rD(p)iffSc∈Ω(Sp,p),3.forall(c,p)∈E(T)1,wehave(c,p)∈↓rD(p)iffS(c,p)∈Ω(Sp,p).ThefollowinglemmashowsthatwithanygivenhierarchicalcoverSitispossibletoassociateauniquedecompositiontree(D,r).Lemma3.AhierarchicalcoverSofTdeﬁnesauniquedecompositiontree(D,r)suchthatifS∈Sthereexistsav∈V(D)suchthatS=Svandifv,w∈V(D)andv#=w,thenSv#=Sw.ForagivenhierarchicalcoverSinthefollowingwedeﬁnetheheightandtheexposure:twopropertieswhichmeasuredifferentsensesofthe“size”ofacover.TheheightofahierarchicalcoverSistheheightoftheassociateddecompositiontreeD.NotethattheheightofadecompositiontreeDmaybeexponentiallysmallerthantheheightofT,since,forexample,itisnotdifﬁculttoshowthatthereexistsadecompositiontreeisomorphictoabinarytreewhentheinputtreeTisapathgraph.IfR⊆TandSRisahierarchicalcoverofR,wedeﬁnetheexposureofSR(withrespecttotreeT)asmaxQ∈SR|∂T(Q)|.Thustheexposureisameasurerelativetoa“containing”tree(whichcanbetheinputtreeTitself)andtheheightisindependentofanycontainingtree.InSection4thecoveringsubtreescorrespondtocached“jointdistributions,”whicharedeﬁnedontheboundaryverticesofthesubtrees,andrequirememoryexponentialintheboundarysize.Thusweareinterestedincoverswithsmallexposure.Wenowdeﬁneameasureoftheoptimalheightwithrespecttoagivenexposurevalue.Deﬁnition4.Ahierarchicalcoverwithexposureatmostkiscalledak-hierarchicalcover.GivenanysubtreeR⊆T,thek-decompositionpotentialχk(R)ofRistheminimumheightofallhierar-chicalcoversofSRwithexposure(withrespecttoT)notlargerthank.The∗-decompositionpoten-tialχ∗(R)istheminimumheightofallhierarchicalcoversofR.If|∂T(R)|>kthenχk(R):=∞.Let’sconsidersomeexamples.Givenastargraph,i.e.,agraphwithasinglecentralvertexandanynumberofadjacentvertices,thereisinfactonlyonepossiblehierarchicalcoverobtainedbysplittingthecentralvertexsothatχ∗(star)=1.Forpathgraphs,χ∗(path)=Θ(log|path|),asmentionedabove.Aninterestingexampleisastarwithpathgraphsratherthansingleedges.Speciﬁcally,astar-pathmaybeformedbyasetof|star-path|log|star-path|pathgraphsP1,P2,...eachwithlog|star-path|edges.Thesepathgraphsarethenjoinedatacentralvertex.Inthiscasewehaveχ∗(star-path)=O(loglog(|star-path|));aseachpathhasahierarchicalcoverofheightO(loglog(|star-path|)),eachofthesepathcoversmaythenbejoinedtocreateacoverofthestar-path.InTheorem6wewillseethegenericboundχ∗(T)≤O(min(∆(T),log|V(T)|)).Thestar-paththusillustratesthattheboundmaybeexponentiallyloose.InTheorem6wewillseethatχ2(T)≤2χ∗(T).Thuswemayrestrictouralgorithmtohierarchicalcoverswithanexposureof2atverylittlecostinefﬁciency.Hence,wewillnowfocusourattentionon2-hierarchicalcovers.2-Hierarchicalcovers.GivenanyelementQ#=Tina2-hierarchicalcoverofTthen|∂T(Q)|∈{1,2}.Considerthecaseinwhich∂T(Q)={v,w},i.e.|∂T(Q)|=2.ThenQcanbespeciﬁedby1Observethat(c,p)∈E(T)impliesc,p∈V(T)and(c,p)∈leaves(D).3thetwoverticesv,wanddeﬁnedasfollows:Q:=!wv":=argmaxS⊆T(|V(S)|:v,w∈leaves(S)),thatisthemaximalsubtreeofT,havingvandwamongitsleaves.Considernowthecaseinwhich∂T(Q)={w},i.e.|∂T(Q)|=1.QisnowdeﬁnedastheT’ssubtreecontainingvertexwtogetherwithallthedescendents⇓wT(z)wherez∈NT(w).Hence,asubtreesuchasQcanbeuniquelydeterminedbythew’sneighborz∈NT(w).InordertodenotesubtreeQinthiscaseweusethefollowingnotation:Q:=!w!z".Observethatonecanalsorepresenta“boundaryone”subtreewiththepreviousnotationbywritingQ:=!w"",where#isany2chosenleafofTbelongingto⇓wT(z)(seeFigure1).(2,s)-Hierarchicalcovers.Wenowintroducethenotionof(2,s)-hierarchicalcovers(which,forsimplicity,weshallalsocall(2,s)-covers)withrespecttoarootedtree(T,s).Thisnotionexplicitlydependsonagivenvertexs∈V(T),which,forthesakeofsimplicity,willbeassumedtobealeafofT.(2,s)-Hierarchicalcoversareguaranteedtonotbemuchlargerthana2-hierarchicalcover(seeTheorem6).Theyarealsoamenabletoabottom-upconstruction.Deﬁnition5.GivenanysubtreeR⊆T,a2-hierarchicalcoverSRisa(2,s)-hierarchicalcoverofRif,forallS∈SR\{T},thereexistsv,w∈Swherev∈⇓sT(w)suchthat(case1:|∂T(Q)|=1)S=!w!v",or(case2:|∂T(Q)|=2)S=!wv".Intheformercasev∈↓sT(w).Wedeﬁneχ2s(R)tobetheminimalheightofanypossible(2,s)-hierarchicalcoverofR⊆T.Thuseverysubtreeofa(2,s)-hierarchicalcoverisnecessarily“oriented”withrespecttoaroots.3ComputinganoptimalhierarchicalcoverFroma“bigpicture”perspective,a(2,s)-hierarchicalcoverGisrecursivelyconstructedinabottom-upfashion:intheinitializationphaseGcontainsonlytheatomiccomponentsconveringT,i.e.theonesformedonlybyapairofadjacentverticesofV(T).Wehavethenatthisstage|G|=|E(T)|.ThenGgrowsstepbystepthroughtheadditionofnewcoveringsubtreesofT.Ateachtimestept,atleastonesubtreeofTisaddedtoG.Allthesubtreesaddedateachsteptmuststrictlycontainonlysubtreesaddedbeforestept.Wenowintroducetheformaldescriptionofourmethodforconstructinga(2,s)-hierarchicalcoverG.Aswesaid,theconstructionofGproceedsinincrementalsteps.AteachsteptthemethodoperatesonatreeTt,whoseverticesarepartofV(T).TheconstructionofTtisaccomplishedstartingbyTt−1(ift>0)insuchawaythatV(Tt)⊂V(Tt−1),whereT0issettobethesubtreeof(T,s)containingtherootandalltheinternalvertices.Duringeachsteptallthewhile-loopinstructionsofFigure1areexecuted:(1)somevertices(theblackonesinFigure1)areselectedthroughadepth-ﬁrstvisit(duringthebacktrackingsteps)ofTtstartingfroms3,(2)foreachselectedvertexv,subtreeSvisobtainedfrommergingsubtreesaddedtoGinpreviousstepsandoverlappingatvertexv,(3)inordertocreatetreeTt+1fromTtthepreviouslyselectedverticesofTtareremoved,(4)theedgesetE(Tt+1)iscreatedfromE(Tt)insuchawaytopreservetheTt’sstructure,butalltheedgesincidenttotheverticesremovedfromV(Tt)(theblackverticesFigure1)inthewhile-loopstep3needtobedeleted.ThepossibledisconnectionthatwouldarisebytheremovalofthesepartsofTtisavoidedbycompletingtheconstructionofEt+1throughtheadditionofsomenewedges.TheseadditionaledgesarenotpartofE(T)andlinkeachvertexvwithitsgrand-parentinTtifvertexv’sparentwasdeleted(seethedashedlineedgesinFigure1)duringtheconstructionofTt+1fromTt.Intheﬁnalwhile-loopstepthevariabletgetsincrementedby1.Basically,thekeyforobtainingoptimalitywiththisconstructionmethodcanbeexplainedwiththefollowingobservation.Ateachtimestept,whenweaddacoveringsubtreeSvforsomevertexv∈V(Tt)selectedbythealgorithm(blackverticesinFigure1),thewhole(2,s)-coverofSvbecomescompletelycontainedinGanditsheightist+1,whichcanbeproventobetheminimumpossibleheightofa(2,s)-coverofSv.Hence,ateachtimesteptweconstructthet+1-thlevel(inthehierarchicalnestedsense)ofGinsuchawaytoachievelocaloptimalityforallelementscontainedinalllevelssmallerorequaltot+1.Asthenexttheoremstates,therunningofthealgorithmislinearin|V(T)|.2Thisrepresentationisnotnecessarilyunique,asif!1,!2∈leaves(T)∩Q,wehave!w!1"=!w!2"#=!w"z"$.3ObservethatsistheuniquevertexbelongingtoV(Tt)foralltimestepst≥0.4Theorem6.Givenarootedtree(T,s),thealgorithminFigure1outputsG,anoptimal(2,s)-hierarchicalcoverintimelinearin|V(T)|ofheightχ2s(T)whichisboundedasχ∗(T)≤χ2(T)≤χ2s(T)≤2χ∗(T)≤O(min(log|V(T)|,∆(T))).Beforeweprovidethedetaileddescriptionofthealgorithmforconstructinganoptimal(2,s)-hierarchicalcoverweneedsomeancillarydeﬁnitions.Wecallavertexv∈V(Tt)\{s}mergeable(attimet)ifandonlyifeither(i)v∈leaves(Tt)or(ii)vhasasinglechildinTtandthatchildisnotmergeable.Ifv∈V(Tt)\{s}ismergeablewewritev∈Mt.Wealsousethefollowingshorthandsformakingmoreintuitiveournotation:Wesetctv:=↓sTt(v)when|↓sTt(v)|=1,ptv:=↑sTt(v)whenv#=sandgtv:=↑sTt(ptv)whenv,ptv#=s.Finally,givenu,u#∈V(T)suchthatu#∈⇓sT(u),weindicatewithwith↓sT(u1→u#)thechildofuwhichisancestorofu#inT.—————————————————————Input:Rootedtree(T,s).—————————————————————Initialisation:T0←T•∪{s};t←0;G←¶!↑sT(v)v":v∈V(T)\{s}©.—————————————————————While#V(Tt)&={s}$1.ConstructMtviadepth-ﬁrstsearchofTtfroms.2.Forallv∈Mt,mergeasfollows:Ifv∈leaves(Tt)thenz←↓sT(ptv(→v).G←G∪!ptv"z".ElseG←G∪!ptvctv".3.V(Tt+1)←V(Tt)\Mt.4.E(Tt+1)←{(v,ptv):v,ptv∈V(Tt+1)}∪{(v,gtv):v,gtv∈V(Tt+1),ptv&∈V(Tt+1)}.5.t←t+1.—————————————————————Output:Optimal(2,s)-hierarchicalcoverGofT.—————————————————————!"!!!"#$%&’!$!%($!"!!!"#$%&’!$!%(%)*)*!+!+!"!"#*%&’!!!$!"(+!"#$%&’!"!%(!!!!#))*!+!$$,-./01-23-45-26786(,-./01-23-45-26786(696(:45-260;/.74<1-460;6(=-.5->?@-6A-./01-2B<?/.--26>44-46/76/C-6D$E2FGH0-.>.1C01>@617A-.///Figure1:Left:Pseudocodeforthelineartimeconstructionalgorithmforanoptimal(2,s)-hierarchicalcover.Right:Pictorialexplanationofthepseudocodeandthedetailsofthehierarchicalcover.Inordertoclarifythemethod,wedescribesomeofthedetailsofthecoverandsomemergeoperationsthatareperformedinthediagram.Vertex1istherootvertexs.Ineachcomponent,depictedasenclosedinaline,theblacknodeisthesplittingvertex,i.e.,amergeablevertexofthetreeTt.Theboundarydeﬁnitionmaybeclariﬁedbyhighlighting,forinstance,that∂T(S2)={4}and∂T(S10)={8,12}.SubtreeS2containsvertices1,2,3and4.Vertex2isthesplittingvertexofS2.Ω(S2,2)={S(1,2),S(2,3),S(2,4)},i.e.,attimet=0,S2isformedbymergingthethreeatomicsubtreesS(1,2),S(2,3)andS(2,4),whichwereaddedintheinitializationstep.Thesethreesubtreesoverlapatonlyvertex2,whichisdepictedinblackbecauseitismergeableinT0.Forwhatconcernsthedecompositiontree(D,r),wehave↓rD(5)={(4,5),6},whichimpliesthatS5isthereforeformedbytheatomiccomponentS(4,5)andthenon-atomiccomponentS6.Attimet=1,S12isobtainedbymergingS10togetherwithS13,whichhavebeenbothcreatedattimet=0.ObservethatinT1vertex12isaleafandthezvariableinthewhile-loopstep2isassignedtovertex10(vandandptvisrespectivelyvertex12and8).Regardingthesubtreerepresentationwiththesquarebracketnotationwecanwrite,forinstance,S2=!14"andS12=!8"10"(≡!811"≡!814").Observethat,accordingtothedeﬁnitionofa(2,s)-hierarchicalcover,wehave4∈⇓1T(1)and10∈↓1T(8).Finally,noticethattheheightofthe(2,s)-hierarchicalcoverofSvisequaltot+1iffvisdepictedinblackinTt.4OnlinemarginalizationInthissectionweintroduceouralgorithmforefﬁcientlycomputingmarginalsbysummingoverproductsofvariablesinatreetopology.Formallyourmodelisspeciﬁedbyatriple(T,Θ,D)where5Tisatree,Θ=(θe,l,m:e∈E(T),l∈INk,m∈INk)sothatθeisapositivesymmetrick×kmatrixandD=(dv,c:v∈V(T),c∈INk)isa|V(T)|×kmatrix.Inaprobabilisticsettingitisnaturaltovieweachnormalizedθeasastochasticsymmetric“transition”matrixandthe“data”Dasarightstochasticmatrixcorrespondingto“beliefs”aboutkdifferentlabelsateachvertexinT.InouronlinesettingΘisaﬁxedparameterandDischangingovertimeandthusanelementinasequence(D1,...,Dt,...)wheresuccessiveelementsonlydifferinasinglerow.Thusateachpointattimewereceiveinformationatasinglevertex.Inourintendedapplication(seeSection5)ofthemodelthereisnonecessary“randomness”inthegenerationofthedata.Howeverthelanguageofprobabilityprovidesanaturalmetaphorweuseforourcomputedquantities.Thusa(k-ary)labelingofTisavectorµ∈LwithL:=INV(T)kandits“probability”withrespectto(Θ,D)isp(µ|Θ,D):=1Z%(i,j)∈E(T)θ(i,j),µ(i),µ(j)%v∈V(T)dv,µ(v),(1)withthenormalisingconstantZ:=&µ∈L’(i,j)∈E(T)θ(i,j),µ(i),µ(j)’v∈V(T)dv,µ(v).Wedenotethemarginalprobabilityatavertexvasp(v→a|Θ,D):=(µ∈L:µ(v)=ap(µ|Θ,D).(2)Usingthehierarchicalcoverforefﬁcientonlinemarginalization.IntheprevioussectionwediscussedamethodtocomputeahierarchicalcoverofatreeTwithoptimalheightχ2s(T)intimelinearinT.Inthissubsectionwewillshowhowthesecoveringcomponentsformacoveringsetofcached“marginals”’.Sothatwemayeithercomputep(v→a|Θ,D)orupdateasinglerowofthedatamatrixDandrecomputethechangedcachedmarginalsallintimelinearinχ2s(T).Deﬁnition7.GivenatreeS⊆T,thepotentialfunction,ψST:L(∂T(S))→Rwithrespectto(Θ,D)isdeﬁnedby:ψST(˜µ):=(µ∈L(S):µ(∂T(S))=˜µÑ%(v,w)∈E(S)θ(v,w),µ(v),µ(w)éÑ%v∈S\∂T(S)dv,µ(v)é(3)WhereL(X):=INXkwithX⊆V(T)isthustherestrictionofLtoXandlikewiseifµ∈Lthenµ(X)∈L(X)istherestrictionofµtoX.ForeachtreeinourhierarchicalcoverS∈Swewillhaveanassociatedpotentialfunction.Intuitivelyeachofthesepotentialfunctionssummarizetheinformationintheirinteriorbythemarginalfunctiondeﬁnedontheirboundary.ThustreesS∈Swithaboundarysizeof1requirekvaluestobecached,the“α”weights;whileboundarysize2treesrequiresk2values,the“β”weights.Thisclariﬁesourmotivationtoﬁndacoverwithbothsmallheightandexposure.Wealsocacheγweightsthatrepresenttheproductofαweights;theseweightsallowefﬁcientcomputationonhighdegreevertices.ThesetofcachedvaluesnecessaryforfastonlinecomputationcorrespondtothesethreetypesofweightsofwhichthereisalinearquantityandonanygivenupdateormarginalizationsteponlyO(χ2s(T))ofthemareaccessed.Deﬁnitionsofweightsandpotentials.GivenatreeTandahierarchicalcoverSitisisomorphictoadecompositiontree(D,r).Thedecompositiontreewillserveadualpurpose.First,eachvertexz∈Dwillserveasa“name”foratreeSz∈S.Second,inthesamewaythatthe“messagespassing”inbeliefpropagationthefollowsthetopologyoftheinputtree,thestructureofourcomputationsfollowsthedecompositiontreeD.Wenowintroduceournotationsforcomputingandtraversingthedecompositiontree.Asthecoverhastreeswithoneortwoboundaryvertices(exceptingTwhichhasnone)wedeﬁnethecorrespondingverticesofthedecompositiontree,Ci:={z∈D:|∂T(Sz)|=i}fori∈{1,2}.Inthissectionsinceweareconcernedwiththetraversalof(D,r)weabbreviate↓D,↑Dasboth↓,↑respectivelyasconvenient.As↓D(v)isasetofchildren,wedeﬁnethefollowingfunctionstoselectspeciﬁcchildren,)(v):=wifw∈↓(v),↑(v)∈∂T(S(w))forv∈D•∩(C1∪C2)and*(v):=wifw∈↓(v),w#=)(v)forw∈C2andv∈D•∩C2.Whenclearfromthecontextwewilluse)vfor)(v)aswellas*vfor*(v).WealsoneednotationforthepotentiallytwoboundaryverticesofatreeSv∈Sifv∈D\{r}.Observethatforv∈C1∪C2oneboundaryvertexofSvisnecessarily˙v:=↑vandifv∈C2thereexistsanancestor¨vofvinDofsothat{˙v,¨v}=∂T(Sv).Wealsoextendthesplitnotationtopickoutthespeciﬁc6αa(v):=ψSvT(˙v→a),(v∈C1)γa(v):=dva’w∈↓(v)∩C1αa(w),(v∈V(T))βab(v):=ψSvT(˙v→a,¨v→b),(v∈C2)ρa(v):=dva’R∈Ω(T,v)ψRT(v→a),(v∈V(T))δ#a(v):=d˙vaψΩ(T,˙v,v)T(˙v→a),(v∈V(T)\{r})δ$a(v):=d¨vaψΩ(T,¨v,v)T(¨v→a),(v∈C2)#a(v):=ψΩ(T,v,˙v)T(v→a),(v∈V(T)\{r})$a(v):=ψΩ(T,v,¨v)T(v→a),(v∈C2)Table1:WeightdeﬁnitionscomplementarysubtreesofTresultingfromasplitthusΩ(T,p,q):=Q∈Ω(T,p)ifq∈QanddeﬁneΩ(T,p,q):=∪{R∈Ω(T,p):q#∈R}.ObservethatT=Ω(T,p,q)∪Ω(T,p,q)and{p}=Ω(T,p,q)∩Ω(T,p,q).Weshallusethenotation(v1→a1,v2→a2,...,vm→am)torepresentalabelingof{v1,v2,...,vm}thatmapsvitoai.InTable1wenowgivetheweightsusedinouronlinemarginalizationalgorithm.Theαa,βab,γaweightsarecachedvaluesmaintainedbythealgorithmandtheweightsρa,δ$a,δ%a,$a,and%aaretemporaryvalues4computed“on-the-ﬂy.”Theindicesa,b∈INkandthusthememoryrequirementsofouralgorithmarelinearinthecardinalityofthetreeandquadraticinthenumberoflabels.Identitiesforweightsandpotentials.Forthefollowinglemmaweintroducethenotionoftheextensionofalabelling.Weextendbyavertexv∈V(T)andalabela∈INk,thelabellingµ∈L(X)tothelabellingµav∈L(X∪{v})whichsatisﬁesµav(v)=aandµav(X)=µ.Lemma8.Givenatree,S⊆T,andavertexv∈Sthenifv∈S\∂T(S)ψST(µ)=(a∈INkdva%R∈Ω(S,v)ψRT(µav(∂T(R)))elseifv∈∂T(S)thenψST(µ)=%R∈Ω(S,v)ψRT(µ(∂T(R)))ThusadirectconsequenceofLemma8isthatwecancomputethemarginalprobabilityatvasp(v→a|Θ,D)=ρa(v)&b∈INkρb(v).Therecursiveapplicationofsuchfactorizationsisthebasisofouralgorithm(thesefactorizationsaresummarizedinTable2inthetechnicalappendices).Algorithminitializationandcomplexity.InFigure2wegiveouralgorithmforcomputingthemarginalsatverticeswithrespectto(Θ,D).Anumberofouridentitiesassumedforagivenvertexthatitisintheinteriorofthetreeandhenceintheinteriorofdecompositiontree.Thusbeforeweﬁndthehierarchicalcoverofourinputtreeweextendthetreebyaddinga“dummy”edgefromeachleafofthetreetoanewdummyvertex.Thesedummyedgesplaynoroleexcepttosimplifynotation.Thehierarchicalcoveristhenfoundonthisenlargedtree;thecoverheightmayatmostonlyincreasebyone.BysettingthevaluesindummyedgesandverticesinΘandDtoone,thisensuresthatallmarginalcomputationsareunchanged.Therunningtimeofthealgorithmisasfollows.Thecomputationofthehierarchicalcover5islinearin|V(T)|asistheinitializationstep.Theupdateandmarginalizationarelinearincoverheightχ∗(T).ThealgorithmalsoscalesquadraticallyinkonthemarginalizationstepandcubicallyinkonupdateasthemergeoftwoC2treesrequirethemultiplicationoftwok×kmatrices.Thusforexampleifthesetofpossiblelabelsislinearinthesizeofthetreeclassicalbeliefpropagationmaybefaster.FinallyweobservethatwemayreducethecubicdependencetoaquadraticdependenceonkviaacoverwiththeheightboundedbythediameterofTasopposedtoχ∗(T).Thisfollowsastheonlycubicstepisintheupdateofanon-atomic(non-edge)β-potential.Thusifwecanbuildacover,withonlyatomicβ-potentialstherunningtimewillscalewithkquadratically.Weaccomplishthisbymodifyingthecoveralgorithm(Figure1)toonlymergeleafvertices.ObservethattheheightofthiscoverisnowO(diameter(T));andwehaveahierarchicalfactorizationintoα-potentialsandonlyatomicβ-potentials.5Multi-tasklearningintheallocationmodelwithTREE-HEDGEWeconcludebysketchingasimpleonlinelearningapplicationtomulti-tasklearningthatisamenabletoourmethods.Theinspirationisthatwehavemultipletasksandagiventreestruc-turethatdescribesourpriorexpectationof“relatedness”betweentasks(seee.g.,[7,Sec.3.1.3]).4Note:ifforγa(v)iftheproductisemptythentheproductevaluatesto1;andifv∈C1then$a(v):=1.5Theconstructionofthedecompositiontreemaybesimultaneouslyaccomplishedwiththesamecomplexity.7Marginalization(vertexv∈D•):1.w←r2.ρa(w)←γa(r)3.while(w&=v)4.w←↑v(w)5.if(w∈C1)6.δ#a(w)←ρa(↑(w))/αa(w)7.#a(w)←&bβab(*(w))δ#b(w)8.ρa(w)=γa(w)#a(w)9.else10.if(w=*(↑(w)))11.δ#a(w)←$a(↑(w))γa(↑(w))12.δ$a(w)←δ#a(↑(w))13.else14.δ#a(w)←#a(↑(w))γa(↑(w))15.δ$a(w)←δ$a(↑(w))16.#a(w)←&bδ#b(w)βab(*(w))17.$a(w)←&bδ$b(w)βab(+(w))18.ρa(w)←#a(w)$a(w)γa(w)19.20.Output:ρa(v)/(&bρb(v))Initialization:Theα,βandγweightsareinitialisedinabottom-upfashiononthedecompositiontree-weinitialisetheweightsofavertexafterwehaveinitialisedtheweightsofallitschildren.Speciﬁcally,weﬁrstdoadepth-ﬁrstsearchofDstartingfromr:Whenwereachanedge(v,w)∈E(T),ifneithervorwisaleafthenwesetβab((v,w))←θ(v,w),a,botherwiseassumingwisaleafwesetαa(v)←1(dummyedge).Whenwereachavertex,v∈V(T),forthelasttime(i.e.justbeforewebacktrackfromv)thenset:γa(v)←dva’w∈↓(v)∩C1αa(w),andifv∈C2thenβab(v)←&cβca(*(v))βcb(+(v))γc(v),orifv∈C1thenαa(v)←&cβca(*(v))γc(v).Update(vertexv∈D•;datad∈[0,∞)k):1.γa(v)←γa(v)dadva;dv←d;w←v2.while(w&=r)3.if(w∈C1)4.αolda←αa(w)5.αa(w)←&cβca(*(w))γc(w)6.γa(↑(w))←γa(↑(w))αa(w)/αolda7.else8.βab(w)←&cβca(*(w))βcb(+(w))γc(w)9.w←↑(w)Figure2:Algorithm:Initialization,MarginalizationandUpdate1.Parameters:Atriple(T,Θ,D1)andη∈(0,∞).2.Fort=1to!do3.Receive:vt∈V(T)4.Predict:ˆpt=(p(vt→a|Θ,Dt))a∈INk5.Receive:yt∈[0,1]k6.Incurloss:Lmix(yt,ˆpt)7.Update:Dt+1=Dt;Dt+1(vt)=(ˆpt(a)e−ηyt(a))a∈INkFigure3:TREE-HEDGEThuseachvertexrepresentsataskandifwehaveanedgebetweenverticesthenaprioriweexpectthosetaskstoberelated.Thusthehopeisthatinformationreceivedforonetask(vertex)willallowustoimproveourpredictionsonanothertask.ForuseachofthesetasksisanallocationtaskasaddressedoftenwiththeHEDGEalgorithm[4].AsimilarapplicationoftheHEDGEalgorithminmulti-tasklearningwasgivenin[8].Theirtheauthorsconsideredamorechallengingset-upwherethetaskstructureisunknownandthehopeistodowellifthereisaposterioriasmallcliqueofcloselyrelatedtasks.Ourstrongassumptionofprior“tree-structured”knowledgeallowsustoob-tainaveryefﬁcientalgorithmandsharpboundswhicharenotdirectlycomparabletotheirresults.Finally,thisset-upisalsocloselyrelatedtoonlinegraphlabelingproblemasine.g.,[9,10,11].Thustheset-upisasfollows.Weincorporateourpriorknowledgeoftask-relatednesswiththetriple(T,Θ,D1).Thenonatrialt,thealgorithmisgivenavt∈V(T),representingthetask.Thealgorithmthengivesanon-negativepredictionvectorˆpt∈{p:&ka=1p(a)=1}fortaskvtandreceivesanoutcomeyt∈[0,1]k.ItthensuffersamixturelossLmix(yt,ˆpt):=yt·ˆpt.Theaimistopredicttominimizethisloss.WegivethealgorithminFigure3.ThenotationfollowsSection4andthemethodthereinimpliesthatoneachtrialwecanpredictandupdateinO(χ∗(T))time.Weobtainthefollowingtheorem(aproofsketchiscontainedinappendixCofthelongversion).Theorem9.GivenatreeT,avertexsequence$v1,...,v"%andanoutcomesequence$y1,...,y"%thelossoftheTREE-HEDGEalgorithmwiththeparameters(Θ,D1)andη>0is,foralllabelingsµ∈INV(T)k,boundedby!(t=1Lmix(yt,ˆpt)≤cη)!(t=1yt(µ(vt))+ln2η1log2p(µ|Θ,D1)*withcη:=η1−e−η.(4)Acknowledgements.WewouldliketothankDavidBarber,GuyLeverandMassimilianoPontilforvaluablediscussions.We,also,acknowledgetheﬁnancialsupportofthePASCAL2EuropeanNetworkofExcellence.8References[1]DavidBarber.BayesianReasoningandMachineLearning.CambridgeUniversityPress,2012.[2]ChristopherM.Bishop.PatternRecognitionandMachineLearning.Springer,2006.[3]FrankR.Kschischang,BrendenJ.Frey,andHansAndreaLoeliger.Factorgraphsandthesum-productalgorithm.IEEETransactionsonInformationTheory,47(2):498–519,2001.[4]YoavFreundandRobertESchapire.Adecision-theoreticgeneralizationofon-linelearningandanapplicationtoboosting.JournalofComputerandSystemSciences,55(1):119–139,1997.[5]JudeaPearl.ReverendBayesoninferenceengines:Adistributedhierarchicalapproach.InProc.Natl.Conf.onAI,pages133–136,1982.[6]ArthurL.Delcher,AdamJ.Grove,SimonKasif,andJudeaPearl.Logarithmic-timeupdatesandqueriesinprobabilisticnetworks.J.Artif.Int.Res.,4:37–59,February1996.[7]TheodorosEvgeniou,CharlesA.Micchelli,andMassimilianoPontil.Learningmultipletaskswithkernelmethods.JournalofMachineLearningResearch,6:615–637,2005.[8]JacobAbernethy,PeterL.Bartlett,andAlexanderRakhlin.Multitasklearningwithexpertadvice.InCOLT,pages484–498,2007.[9]MarkHerbster,MassimilianoPontil,andLisaWainer.Onlinelearningovergraphs.InICML,pages305–312.ACM,2005.[10]MarkHerbster,GuyLever,andMassimilianoPontil.Onlinepredictiononlargediametergraphs.InNIPS,pages649–656.MITPress,2008.[11]Nicol`oCesa-Bianchi,ClaudioGentile,andFabioVitale.Fastandoptimalpredictiononalabeledtree.InCOLT,2009.9