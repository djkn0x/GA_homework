Ping Li
Dept. of Statistical Science
Cornell University
pingli@cornell.edu

One Sketch For All: Theory and Application of
Conditional Random Sampling
Trevor J. Hastie
Kenneth W. Church
Microsoft Research
Dept. of Statistics
Stanford University
Microsoft Corporation
church@microsoft.com
hastie@stanford.edu
Abstract
Conditional Random Sampling (CRS) was originally proposed for efﬁciently
computing pairwise (l2 , l1 ) distances, in static, large-scale, and sparse data. This
study modiﬁes the original CRS and extends CRS to handle dynamic or stream-
ing data, which much better reﬂect the real-world situation than assuming static
data. Compared with many other sketching algorithms for dimension reductions
such as stable random projections, CRS exhibits a signiﬁcant advantage in that it
is “one-sketch-for-all.” In particular, we demonstrate the effectiveness of CRS in
efﬁciently computing the Hamming norm, the Hamming distance, the lp distance,
and the χ2 distance. A generic estimator and an approximate variance formula are
also provided, for approximating any type of distances.
We recommend CRS as a promising tool for building highly scalable systems, in
machine learning, data mining, recommender systems, and information retrieval.

1 Introduction
Learning algorithms often assume a data matrix A ∈ Rn×D with n observations and D attributes
and operate on the data matrix A through pairwise distances. The task of computing and maintaining
distances becomes non-trivial, when the data (both n and D) are large and possibly dynamic.
For example, if A denotes a term-doc matrix at Web scale with each row representing one Web page,
then n ≈ O(1010 ) (which may be veriﬁed by querying “A” or “The” in a search engine). Assuming
105 English words, the simplest uni-gram model requires the dimension D ≈ O(105 ); and a bi-gram
model can boost the dimension to D ≈ O(1010 ). Google book search program currently provides
data sets on indexed digital books up to ﬁve-grams. Note that the term-doc matrix is “transposable,”
meaning that one can treat either documents or terms as features, depending on applications.
Another example is the image data. The Caltech 256 benchmark contains n = 30, 608 images,
provided by two commercial ﬁrms. Using pixels as features, a 1024 × 1024 color image can be
represented by a vector of dimension D = 10242 × 3 = 3, 145, 728. Using histogram-based features
(e.g., [3]), D = 2563 = 16, 777, 216 is possible if one discretizes the RGB space into 2563 scales.
Text data are large and sparse, as most terms appear only in a small fraction of documents. For
example, a search engine reports 107 pagehits for the query “NIPS,” which is not common to the
general audience. Out of 1010 pages, 107 pagehits indicate a sparsity of 99.9%. (We deﬁne sparsity
as the percentage of zero elements.) In the absolute magnitude, however, 107 is actually very large.
Not all large-scale data are sparse. Image data are usually sparse when features are represented by
histograms; they are, however, dense when pixel-based features are used.

1.1 Pairwise Distances Used in Machine Learning
The lp distance and χ2 distance are both popular. Denote by u1 and u2 the leading two rows in
D(cid:88)
D(cid:88)
A ∈ Rn×D . The lp distance (raised to the pth power), and the χ2 distance, are, respectively,
(u1,i − u2,i )2
|u1,i − u2,i |p ,
0
dχ2 (u1 , u2 ) =
dp (u1 , u2 ) =
u1,i + u2,i
0
(cid:180)1/β
(cid:180)1/α − 21/α
(cid:179)
(cid:179)
i=1
i=1
The χ2 distance is only a special case of Helbertian metrics, deﬁned as,
D(cid:88)
21/β
1,i + uβ
uβ
1,i + uα
uα
2,i
2,i
21/α − 21/β
i=1

, α ∈ [1, ∞), β ∈ [1/2, α] or β ∈ [−∞, −1].

dH,α,β (u1 , u2 ) =

,

(

= 0).

Helbertian metrics are deﬁned over probability space[7] and hence suitable for data generated from
histograms, e.g., the “bag-of-words” model. For applications in text and images using SVM, empir-
ical studies have demonstrated the superiority of Helbertian metrics over lp distances[3, 7, 9].
D(cid:88)
More generally, we are interested in any linear summary statistics which can be written in the form:
i=1
for any generic function g . An efﬁcient method for computing (1) for any g would be desirable.

dg (u1 , u2 ) =

g(u1,i , u2,i ),

(1)

1.2 Bottleneck in Distance/Kernel-based Learning Algorithms
A ubiquitous task in learning is to compute, store, update, and retrieve various types of distances[17].
For popular kernel SVM solvers including the SMO algorithm[16], storing and computing kernels
is the major bottleneck[2], because computing kernels is expensive, and more seriously, storing the
full kernel matrix in memory is infeasible when the number of observations n > 105 .
One popular strategy is to evaluate kernels on the ﬂy[2]. This works well in low-dimensional data
(i.e., relatively small D). With high-dimensional data, however, either computing distances on-
demand becomes too slow or the data matrix A ∈ Rn×D itself may not ﬁt in memory.
We should emphasize that this challenge is a universal issue in distance-based methods, not limited
to SVMs. For example, popular clustering algorithms and multi-dimensional scaling algorithms
require frequently accessing a (di)similarity matrix, which is usually distance-based.
In addition to computing and storing distances, another general issue is that, for many real-world
applications, entries of the data matrix may be frequently updated, for example, data streams[15].
There have been considerable studies on learning from dynamic data, e.g., [5, 1]. Since streaming
data are often not stored (even on disks), computing and updating distances becomes challenging.

1.3 Contributions and Paper Organization
Conditional Random Sampling (CRS)[12, 13] was originally proposed for efﬁciently computing
pairwise (l2 and l1 ) distances, in large-scale static data. The contributions of this paper are:
1. We extend CRS to handle dynamic data. For example, entries of a matrix may vary over
time, or the data matrix may not be stored at all. We illustrate that CRS has the one-sketch-
for-all property, meaning that the same set of samples/sketches can be used for computing
any linear summary statistics (1). This is a signiﬁcant advantage over many other dimen-
sion reduction or data stream algorithms.
For example, the method of stable random
projections (SRP)[8, 10, 14] was designed for estimating the lp norms/distances for a ﬁxed
p with 0 < p ≤ 2. Recently, a new method named Compressed Counting[11] is able to
very efﬁciently approximate the lp moments of data streams when p ≈ 1.
2. We introduce a modiﬁcation to the original CRS and theoretically justify that this mod-
iﬁcation makes CRS rigorous, at least for computing the Hamming norm, an important
application in databases. We point out the original CRS was based on a heuristic argument.
3. We apply CRS for computing Hilbertian metrics[7], a popular family of distances for con-
structing kernels in SVM. We focus on a special case, by demonstrating that CRS is effec-
tive in approximating the χ2 distance.

Section 2 reviews the original CRS. Section 3 extends CRS to dynamic/streaming data. Section 4
focuses on using CRS to estimate the Hamming norm of a single vector, based on which Section 5
provides a generic estimation procedure for CRS, for estimating any linear summary statistics, with
the focus on the Hamming distance and the χ2 distance. Finally, Section 6 concludes the paper.

2 Conditional Random Sampling (CRS), the Original Version
Conditional Random Sampling (CRS)[12, 13] is a local sampling strategy. Since distances are local
(i.e., one pair at a time), there is no need to consider the whole matrix at one time.
As the ﬁrst step, CRS applies a random permutation on the columns of A ∈ Rn×D . Figure 1(a)
provides an example of a column-permuted data matrix. The next step of CRS is to construct a

sketch for each row of the data matrix. A sketch can be viewed as a linked list which stores a small
fraction of the non-zero entries from the front of each row. Figure 1(b) demonstrates three sketches
corresponding to the three rows of the (column) permuted data matrix in Figure 1(a).

(b) Sketches
(a) Permuted data matrix
Figure 1: (a): A data matrix with three rows and D = 16 columns. We assume the columns are
already permuted. (b): Sketches are the ﬁrst ki non-zero entries ascending by IDs (here ki = 4).
In Figure 1, the sketch for row ui is denoted by Ki . Each element of Ki is a tuple “ID {val},” where
“ID” is the column ID after the permutation and “{val}” is the value of that entry.
Consider two rows u1 and u2 . The last (largest) IDs of sketches K1 and K2 are max(ID(K1 )) = 10
and max(ID(K2 )) = 8, respectively. Here, “ID(K)” stands for the vector of IDs in the sketch K. It is
clear that K1 and K2 contain all information about u1 and u2 from columns 1 to min(10, 8) = 8.
Had we directly taken the ﬁrst Ds = 8 columns from the permuted data matrix, we would obtain the
same non-zero entries as in K1 and K2 , if we exclude elements in K1 and K2 whose IDs > Ds = 8.
in this example, the element 10{8} in sketch K1 is excluded.
On the other hand, since the columns are already permuted, any Ds columns constitute a random
sample of size Ds . This means, by only looking at sketches K1 and K2 , one can obtain a “random”
sample of size Ds . By statistics theory, one can easily obtain an unbiased estimate of any linear
summary statistics from a random sample. Since Ds is unknown until we look at K1 and K2 together,
[13] viewed this as a random sample conditioning on Ds .
Note that the Ds varies pairwise. When considering the rows u1 and u3 , the sketches K1 and K3
suggest their Ds = min(max(ID(K1 )), max(ID(K3 ))) = min(10,12) = 10.

In this study, we point out that, although the “conditioning” argument appeared intuitive, it is only a
(good) heuristic. There are two ways to understand why this argument is not strictly correct.
Consider a true random sample of size Ds , directly obtained from the ﬁrst Ds columns of the
permuted data matrix. Assuming sparse data, elements at the Ds th column should be most likely
zero. However, in the “conditional random sample” obtained from CRS, at least one element at the
Ds th column is non-zero. Thus, the estimates of the original CRS are, strictly speaking, biased.
For a more obvious example, we can consider two rows with exactly one non-zero entry in each row
at the same column. The original CRS can not obtain an unbiased estimate unless Ds = D .
3 CRS for Dynamic Data and Introduction to Stable Random Projections
The original CRS was proposed for static data.
In reality, the “data matrix” may be frequently
updated. When data arrive in a streaming fashion, they often will not be stored (even on disks)[15].
Thus, a one-pass algorithm is needed to compute and update distances for training. Learning with
dynamic (or incremental) data has become an active topic of research, e.g., [5, 1].

3.1 Dynamic/Streaming Data
We ﬁrst consider only one data vector u of length D (viewed as one row in the data matrix). At each
time t, there is an input stream st = (it , It ), it ∈ [1, D ] which updates u (denoted by ut ) by
ut [it ] = H(ut−1 [it ], It ),
where It is the increment/decrement at time t and H is an updating function. The so-called Turnstile
model [15] is extremely popular and assumes a linear updating function H, i.e.,
ut [it ] = ut−1 [it ] + It .
(2)
For example, ut [it ] can represent the number of orders a “user” i has purchased up to time t, where
a user may be identiﬁed by his/her IP address (i.e., i ∈ [1, D = 264 ]); It is the number of orders the
user i orders (i.e., It > 0) or cancels (i.e., It < 0) at time t.

5   0   0   1   0   7   0   0   0    8    0    1    0    8    0    2     12uuu31   2   3   4   5   6   7   8   9   10  11  12  13  14  15  160   9   2   0   6   0   0   7   0    5    0    0    4    0    0   13     0   4   0   0   2   0   0   0   8    0    0    3    0    0   12    0     213K  :   1 {5}   4 {1}   6 {7}  10 {8}   K  :   2 {9}   3 {2}   5 {6}   8  {7}K  :   2 {4}   5 {2}   9 {8}   12 {3}   In terms of the data matrix A ∈ Rn×D , we can view it to be a collection of n data streams.
3.2 CRS for Streaming Data
For each stream ut , we maintain a sketch K with length (i.e., capacity) k . Each entry of K is a tuple
“ID{val}.” Initially, all entries are empty. The procedure for sketch construction works as follows:
1. Generate a random permutation π : [1, D ] → [1, D ].
2. For each st = (it , It ), if π [it ] > max(ID(K)) and the capacity of K is reached, do nothing.
3. Suppose π [it ] ≤ max(ID(K)) or the capacity of K is not reached. If an entry with ID =
π [it ] does not exist, insert a new entry. Otherwise, update that entry according to H.1
4. Apply the procedure to each data stream using the same random permutation mapping π .

Once sketches are constructed, the estimation procedure will be the same regardless whether the
original data are dynamic or static. Thus, we will use static data to verify some estimators of CRS.

p, dp =

.

,

|u1,i − u2,i |p

3.3
(Symmetric) Stable Random Projections (SRP)
Since the method of (symmetric) stable random projections (SRP)[8, 10] has become a standard
algorithm for data stream computations, we very brieﬂy introduce SRP for the sake of comparisons.
The procedure of SRP is to multiply the data matrix A ∈ Rn×D by a random matrix R ∈ RD×k ,
whose entries are i.i.d. samples from a standard (symmetric) stable distribution S (p, 1), 0 < p ≤ 2.
(cid:195)
(cid:33)
(cid:195)
(cid:33)
Consider two rows, u1 and u2 , in A. By properties of stable distributions, the projected vectors
D(cid:88)
D(cid:88)
v1 = RTu1 and v2 = RTu2 have i.i.d. stable entries, i.e., for j = 1 to k ,
v1,j − v2,j ∼ S
|u1,i |p
v1,j ∼ S
p, Fp =
i=1
i=1
Thus, one can estimate an individual norm or distance from k samples. SRP is applicable to dy-
namic/streaming data, provided the data follow the Turnstile model in (2). Because the Turnstile
model is linear and matrix multiplication is also linear, one can conduct A × R incrementally.
Compared with Conditional Random Sampling (CRS), SRP has an elegant mathematical deriva-
tion, with various interesting estimators and rigorous sample complexity bounds, i.e., k can be pre-
determined in fully rigorous fashion. The accuracy of SRP is not affected by heavy-tailed data.
CRS, however, exhibits certain advantages over SRP:
• CRS is “one-sketch-for-all”.
The same sketch of CRS can approximate any linear
summary statistics (1). SRP is limited to the lp norm and distance with 0 < p ≤ 2. One has
to conduct SRP 10 times (and store 10 sets of sketches) if 10 different p values are needed.
• CRS allows “term-weighting” in dynamic data.
are often computed using weighted data (e.g., √
In machine learning, the distances
u1,i or log(1 + u1,i )), which is critical for
good performance. For static data, one can ﬁrst term-weight the data before applying SRP.
For dynamic data, however, there is no way to trace back the original data after projections.
• CRS is not restricted to the Turnstile model.
• CRS is not necessary less accurate,
especially for sparse data or binary data.
4 Approximating Hamming Norms in Dynamic Data
Counting the Hamming norm (i.e., number of non-zeros) in an exceptionally long, dynamic vector
has important applications[4, 15]. For example, if a vector ut records the numbers of items users
have ordered, one meaningful question to ask may be “ how many distinct users are there?”
The purpose of this section is three-fold. (1) This is the case we can rigorously analyze CRS and
propose a truly unbiased estimator. (2) This analysis brings better insights and more reasonable
estimators for pairs of data vectors. (3) In this case, despite its simplicity, CRS theoretically achieves
similar accuracy as stable random projections (SRP). Empirically, CRS (slightly) outperforms SRP.
1We leave it for particular applications to decide whether an entry updated to zero should be discarded or
should be kept in the sketch. In reality, this case does not occur often. For example, the most important type of
data streams[15] is “insertion-only,” meaning that the values will never decrease.

,

4.1 The Proposed (Unbiased) Estimator and Variance
Suppose we have obtained the sketch K. For example, consider the ﬁrst row in Figure 1: D = 16,
k = 4 and the number of non-zeros f = 7. Lemma 1 (whose proof is omitted) proposes an unbiased
estimator of f , denoted by ˆf , and a biased estimator based on the maximum likelihood, fmle .
(cid:180)
(cid:179)
Lemma 1
D(k − 1)
(cid:179)
(cid:180)
ˆf =
ˆf
Z − 1
(cid:180)
(cid:179)
ˆf
< V U
f =
ˆf

Z = max(ID(K)),
− (D − f )f
f 2 − f
D
k − 2
D − 1
D − 1
,
f − (k − 1)f (f − 1)(f − 2)D
(cid:179)
(cid:180)
f = V U
> V L
(k − 2)(k − 3)(D − 1)(D − 2)
= f 2
Assume f /D is small and k/f is also small, then Var
ˆf
k + O
(cid:180)
(cid:179)
Z − 1.
The maximum likelihood estimator is ˆfmle = k(D+1)
/f 2 ≈ 1/k , independent of the data, the estimator ˆf actually has the worst-
Note that, since Var
ˆf
case complexity bound similar to that of SRP[10], although the precise constant is not easy to obtain.

(k > 2)
(cid:162)
(cid:161) 1
.
k2

D ≥ f ≥ k > 1

(k > 3).

= f ,

Var

Var

E

,

=

f

=

(3)

=

E

Var

Var

− 1

f

= E

− 1

f
k − 1

Df
D − 1

D
D − 1

4.2 The Approximation Using the Conditioning Argument
D(k−1)
Interestingly, this estimator, ˆf =
max(ID(K))−1 , appears to be the estimator for a hypergeometric
random sample of size Ds = max(ID(K)) − 1. That is, suppose we randomly pick Ds balls (with-
out replacement) from a pool of D balls and we observe that k (cid:48) balls are red; then a natural (and
k (cid:48) ; here k (cid:48) = k − 1.
unbiased) estimator for the total number of red balls would be D
Ds
This seems to imply that the “conditioning” argument in the original CRS in Section 2 is “correct”
if we make a simple modiﬁcation by using the Ds which is the original Ds minus 1. While this is
what we will recommend as the modiﬁed CRS, it is only a close approximation.
(cid:181)
(cid:182)
(cid:181)
(cid:182)
(cid:181)
(cid:182)
(cid:180)
(cid:179)
Consider ˆfapp = ˆf , where we assume ˆfapp is the estimator for the hypergeometric distribution, then
× D − Ds
D2
(cid:182)
(cid:182) (cid:181)
(cid:181)
(cid:182)
(cid:181)
(cid:182)
(cid:182)
(cid:181)
(cid:181)
(cid:180)(cid:180)
(cid:179)
(cid:179)
(cid:180)
(cid:179)
1 − f
D
f
1 − f
D
ˆfapp |Ds = Z − 1
− 1
=
Ds
D − 1
D − 1
D2
D
D
Ds
D
s
ˆfapp |Ds
1 − f
D
ˆfapp
Var
Z − 1
D
(cid:80)D
4.3 Comparisons with Stable Random Projections (SRP)
i=1 |ui |p , [4] proposed using SRP to approximate the
Based on the observation that f = limp→0+
(cid:80)D
lp norm with very small p, as an approximation to f . For p → 0+, the recent work for SRP [10]
proposed the harmonic mean estimator. Recall that after projections v = RTu ∈ Rk consists of
(cid:195)
(cid:195)
(cid:33)(cid:33)
(cid:161)
(cid:162)
i=1 |ui |p . The harmonic mean estimator is
i.i.d. stable samples with scale parameter Fp =
(cid:80)k
(cid:163)
(cid:161)
(cid:162)(cid:164)2 − 1
− 2
π Γ(−p) sin
−πΓ(−2p) sin (πp)
π
(cid:195)
(cid:33)
2 p
k −
(cid:181)
(cid:182)
ˆFp,hm =
(cid:179)
(cid:180)
,
j=1 |vj |−p
Γ(−p) sin
π
2 p
(cid:163)
(cid:161)
(cid:162)(cid:164)2 − 1
−πΓ(−2p) sin (πp)
(cid:182)
(cid:181)
1
1
= F 2
ˆFp,hm
.
+ O
Γ(−p) sin
p
k2
(cid:163)
(cid:161)
(cid:162)(cid:164)2 − 1 → 1.
π
k
2 p
− −πΓ(−2p) sin (πp)
π
− 2
→ 1,
Γ(−p) sin
lim
p
lim
Γ(−p) sin
p→0+
p→0+
π
2
π
2 p
Denote this estimator by ˆfsrp (using p as small as possible), whose variance is Var
which is roughly equivalent to the variance of ˆf , the unbiased estimator for CRS.
We empirically compared CRS with SRP. Four word vectors were selected; entries of each vector
record the numbers of occurrences of the word in D = 216 Web pages. The data are very heavy-
tailed. The percentage of zero elements (i.e., sparsity) varies from 58% to 95%.
Figure 2 presents the comparisons. (1): It is possible that CRS may outperform SRP non-negligibly.
(2): The variance (3) based on the approximate “conditioning” argument is very accurate.
(3): The
unbiased estimator ˆf is more accurate than ˆfmle ; the latter actually uses one more sample.

≈ f 2
k ,

1 − f
D

(cid:179)

(cid:180)

ˆfsrp

Var

Figure 2: Comparing CRS with SRP for approximating Hamming norms in Web crawl data (four
word vectors), using the normalized mean square errors (MSE, normalized by f 2 ). “CRS” and
“CRS+mle” respectively correspond to ˆf and ˆfmle , derived in Lemma 1. ”SRP” corresponds to the
harmonic mean estimator of SRP using p = 0.04. “1/k” is the theoretical asymptotic variance of
both CRS and SRP. The curve labeled ”Approx. Var” is the approximate variance in (3).

5 The Modiﬁed CRS Estimation Procedure
The modiﬁed CRS estimation procedure is based on the theoretical analysis for using CRS to ap-
proximate Hamming norms. Suppose we are interested in the distance between rows u1 and u2 and
we have access to sketches K1 and K2 . Our suggested “equivalent” sample size Ds would be
Ds = min{Z1 − 1, Z2 − 1},
Z1 = max(ID(K1 ), Z2 = max(ID(K2 ).
We should not include elements in K1 and K2 whose IDs are larger than Ds
Consider K1 and K2 in Figure 1, the modiﬁed CRS adopts Ds = min(10 − 1, 8 − 1) = min(9, 7) =
7. Removing 10{8} from K1 and 8{7} from K2 , we obtain a sample for u1 and u2 :
˜u1,1 = 5, ˜u1,4 = 1, ˜u1,6 = 7,
˜u2,2 = 9, ˜u2,3 = 2, ˜u2,5 = 6.
All other sample entries are zero: ˜u1,2 = ˜u1,3 = ˜u1,5 = ˜u1,7 = 0, ˜u2,1 = ˜u2,4 = ˜u2,6 = ˜u2,7 = 0.
5.1 A Generic Estimator and Approximate Variance
(cid:80)D
Rigorous theoretical analysis on one pair of sketches is difﬁcult. We resort to the approximate
“conditioning” argument using the modiﬁed Ds in (4). We consider a generic distance dg (u1 , u2 ) =
i=1 g (u1,i , u2,i ), and assume that, conditioning on Ds , the sample { ˜u1,j , ˜u2,j }Ds
j=1 is exactly
equivalent to the sample from randomly selected Ds columns without replacement. Under this
D(cid:88)
Ds(cid:88)
Ds(cid:88)
assumption, an “unbiased” estimator of dg (u1 , u2 ) (and two special cases) would be
( ˜u1,j − ˜u2,j )2
| ˜u1,j − ˜u2,j |p ,
D
D
ˆdg (u1 , u2 ) =
ˆdp =
˜u1,j + ˜u2,j
Ds
Ds
i=1
j=1
j=1
(cid:180)
(cid:179)
(cid:179)
(cid:179)
(cid:180)
(cid:180)
A generic (approximate) variance formula can be obtained as follows:
≈ D − Ds
× D2
(cid:33)2 =
 1
(cid:195)
ˆdg (u1 , u2 )|Ds
− E2 (g( ˜u1,j , ˜u2,j ))
(cid:181)
g2 ( ˜u1,j , ˜u2,j )
E
D(cid:88)
D(cid:88)
Ds
D − 1
D2
s
g2 (u1,i , u2,i ) −
g(u1,i , u2,i )
Ds
D
(cid:181)
(cid:181)
(cid:179)
(cid:179)
(cid:180)
(cid:179)
(cid:180)(cid:180)
i=1
i=1
(cid:33)
(cid:182) (cid:195)
ˆdg (u1 , u2 )|Ds
D
(cid:181)
(cid:182)
(cid:181)
ˆdg (u1 , u2 )
E
=
D − 1
dg2 − d2
(cid:182) (cid:195)
− 1
(cid:181)
(cid:182)(cid:190)
g
E
D
dg2 − d2
(cid:33)
(cid:182) (cid:195)
D
(cid:181)
g
max
Z2 − 1
D
dg2 − d2
g
max
D

(cid:182) (cid:195)
dg2 − d2
g
(cid:33)
D

D
(cid:182) (cid:195)
Ds
dg2 − d2
g
D

max{ D
(cid:189)
(cid:181)
Z1 − 1
(cid:189)

D
Z1 − 1

D
(cid:181)
(cid:182)
,
Z2 − 1
(cid:190)

, E

D
D − 1
(cid:182)

f1
k1 − 1

,

f2
k2 − 1

D − Ds
D − 1

D
Ds
(cid:33)

≈ D
D − 1

=

D
D − 1

D2
D2
s

Var

=

D
D − 1

Var

=

− 1

.

.

(cid:33)

.

D
Ds

g( ˜u1,j , ˜u2,j ),

E

− 1

− 1

− 1

≈ E

Var

1
D

}

ˆdχ2 =

(4)

(5)

Here, k1 and k2 are the sketch sizes of K1 and K2 , respectively, f1 and f2 are the numbers of non-
zeros in the original data, u1 , u2 , respectively. We have used the results in Lemma 1 and a common
statistical approximation: E(max(x, y)) ≈ max (E(x), E(y)).

31020304010−1100kStandardized MSETHIS  CRSCRS+mleSRP1/kApprox. Var31020304010−1100kStandardized MSEHAVE  CRSCRS+mleSRP1/kApprox. Var31020304010−1100kStandardized MSEADDRESS  CRSCRS+mleSRP1/kApprox. Var31020304010−1100kStandardized MSECUSTOMER  CRSCRS+mleSRP1/kApprox. Var(cid:110)
(cid:111)
If the data are very sparse, i.e.,
From (5), we know the variance is affected by two factors.
max
f1
f2
is small, then the variance also tends to be small. If the data are heavy-tailed,
k1−1 ,
k2−1
i.e., Ddg2 (cid:192) d2
g , then the variance tends to be large. Text data are often highly sparse and heavy-
tailed; but machine learning applications often need to use the weighted data (i.e., taking logarithm
or binary quantization). This is why we expect CRS will be successful in real applications, although
it in general does not have the worst-case performance guarantees.
The next two subsections apply CRS to estimating the Hamming distance and the χ2 distance.
Empirical studies [3, 7, 9] have demonstrated that, in text and image data, using the Hamming
distance or the χ2 distance for kernel SVMs achieved good performance.
(cid:80)D
5.2 Estimating the Hamming Distance
i=1 1{u1,i − u2,i (cid:54)= 0}, we esti-
Following the deﬁnition of Hamming distance in [4]: h (u1 , u2 ) =
(cid:182)
(cid:182) (cid:181)
(cid:190)
(cid:189)
(cid:181)
(cid:180)
(cid:179)
mate h using the modiﬁed CRS procedure, denoted by ˆh. The approximate variance (5) becomes
h − h2
− 1
D

≈ D
f2
f1
k2 − 1
k1 − 1
D − 1
We also apply SRP using small p and its most accurate harmonic mean estimator[10]. The empirical
comparisons in Figure 3 verify two points. (1): CRS can be considerably more accurate than SRP for
estimating Hamming distances in [4]. (2): The approximate variance formula (6) is very accurate.

max

Var

(6)

ˆh

.

,

Figure 3: Approximating Hamming distances (h) using two pairs of words. The results are presented
in terms of the normalized (by h2 ) MSE. The curves labeled “Approx. Var” correspond to the
approximate variance of CRS in (6).
(cid:80)D
In this example, the seemingly impressive improvement of CRS over SRP is actually due to that we
used the deﬁnition of Hamming distance in [4]. An alternative deﬁnition of Hamming distance is
i=1 [1 {u1,i (cid:54)= 0 and u2,i = 0} + 1 {u1,i = 0 and u2,i (cid:54)= 0}], which is basically the
h(u1 , u2 ) =
lp distance after a binary term-weighting. As we have commented, if using SRP in dynamic data,
term-weighting is not possible; thus we only experimented with the deﬁnition in [4].
(cid:80)D
5.3 Estimating the χ2 Distance
We apply CRS to estimating the χ2 distance between u1 and u2 : dχ2 (u1 , u2 ) =
(cid:182) (cid:195)
(cid:33)
(cid:189)
(cid:181)
(cid:190)
i=1
D(cid:88)
According to (5), the estimation variance should be approximately
(u1,i − u2,i )4
(u1,i + u2,i )2 − d2
χ2
,
(u1,i+u2,i )2 ≤ (cid:80)D
(cid:80)D
D
i=1
(u1,i−u2,i )4
which is affected only by the second moments, because
i=1 (u1,i + u2,i )2 .
i=1
There are proved negative results [6] that in the worst-case no efﬁcient algorithms exist for approx-
imating the χ2 distances. CRS does not provide any worst-case guarantees; its performance relies
on the assumption that the data are often reasonably sparse and the second moments should be
reasonably bounded in machine learning applications.
Figure 4 presents some empirical study, using the same four words, plus the UCI Dexter data. Even
though the four words are fairly common (i.e., not very sparse) and they are heavy-tailed (no term-
weighting was applied), CRS still achieved good performance in terms of the normalized MSE (e.g.,
≤ 0.1) at reasonably small k . And again, the approximate variance formula (7) is accurate.
Results in the Dexter data set (which is more realistic for machine learning) are encouraging. Only
about k = 10 is needed to achieve small MSE.

(u1,i−u2,i )2
u1,i+u2,i

f2
k2 − 1

f1
k1 − 1

D
D − 1

− 1

max

,

.

(7)

1020304010−210−1100kStandardized MSE  THIS − HAVECRSApprox. VarSRP1020304010−210−1100kStandardized MSE  ADDRESS − CUSTOMERCRSApprox. VarSRPFigure 4: Left two panels: CRS for approximating the χ2 distance using two pairs of words (D =
216 ). The curves report the normalized MSE and the approximate variance in (7).
Right-most panel: The Dexter data, D = 20000, with 300 data points. We estimate all pairwise (i.e.,
44850 pairs) χ2 distances using CRS. The three curves report the quantiles of normalized MSEs.

6 Conclusion
The ubiquitous phenomenon of massive, high-dimensional, and possibly dynamic data, has brought
in serious challenges. It is highly desirable to achieve compact data presentation and efﬁciently
computing and retrieving summary statistics, in particular, various types of distances. Conditional
Random Sampling (CRS) provides a simple and effective mechanism to achieve this goal.
Compared with other “main stream” sketching algorithms such as stable random projections (SRP),
the major advantage of CRS is that it is “one-sketch-for-all,” meaning that the same set of sketches
can approximate any linear summary statistics. This would be very convenient in practice.
The major disadvantage of CRS is that it relies heavily on the data sparsity and also on the assump-
tion that in machine learning applications the “worst-case” data distributions are often avoided (e.g.,
through term-weighting). Also, the theoretical analysis is difﬁcult, despite it is a simple algorithm.
Originally based on a heuristic argument, the preliminary version of CRS, was proposed as a tool
for computing pairwise l2 and l1 distances in static data. This paper provides a partial theoretical
justiﬁcation of CRS and various modiﬁcations, to make the algorithm more rigorous and to extend
CRS for handling dynamic/streaming data. We demonstrate, empirically and theoretically, the ef-
fectiveness of CRS in approximating the Hamming norms/distances and the χ2 distances.
Acknowledgement
Ping Li is partially supported by grant DMS-0808864 from the National Science Foundation, and
a gift from Microsoft. Trevor Hastie was partially supported by grant DMS-0505676 from the
National Science Foundation, and grant 2R01 CA 72028-07 from the National Institutes of Health.
References
[1] Charu C. Aggarwal, Jiawei Han, Jianyong Wang, and Philip S. Yu. On demand classiﬁcation of data streams. In KDD, 503–508, 2004.
[2] L ´eon Bottou, Olivier Chapelle, Dennis DeCoste, and Jason Weston, editors. Large-Scale Kernel Machines. The MIT Press, 2007.
[3] Olivier Chapelle, Patrick Haffner, and Vladimir N. Vapnik. Support vector machines for histogram-based image classiﬁcation. IEEE
Trans. Neural Networks, 10(5):1055–1064, 1999.
[4] Graham Cormode, Mayur Datar, Piotr Indyk, and S. Muthukrishnan. Comparing data streams using hamming norms (how to zero in).
IEEE Transactions on Knowledge and Data Engineering, 15(3):529–540, 2003.
[5] Carlotta Domeniconi and Dimitrios Gunopulos. Incremental support vector machine construction. In ICDM, pages 589–592, 2001.
[6] Sudipto Guha, Piotr Indyk, and Andrew McGregor. Sketching infomration divergence. In COLT, pages 424–438, 2007.
[7] M. Hein and O. Bousquet. Hilbertian metrics and positive deﬁnite kernels on probability measures. In AISTATS, pages 136–143, 2005.
[8] Piotr Indyk. Stable distributions, pseudorandom generators, embeddings, and data stream computation. J. of ACM, 53(3):307–323, 2006.

[9] Yugang Jiang, Chongwah Ngo, and Jun Yang. Towards optimal bag-of-features for object categorization and semantic video retrieval. In
CIVR, pages 494–501, 2007.
[10] Ping Li. Estimators and tail bounds for dimension reduction in lα (0 < α ≤ 2) using stable random projections. In SODA, 2008.
[11] Ping Li. Compressed Counting. In SODA, 2009.
[12] Ping Li and Kenneth W. Church. A sketch algorithm for estimating two-way and multi-way Associations. Computational Linguistics,
33(3):305-354, 2007. Preliminary results appeared in HLT/EMNLP, 2005.
[13] Ping Li, Kenneth W. Church, and Trevor J. Hastie. Conditional random sampling: A sketch-based sampling technique for sparse data. In
NIPS, pages 873–880, 2007.
[14] Ping Li. Computationally efﬁcient estimators for dimension reductions using stable random projections. In ICDM, 2008.
[15] S. Muthukrishnan. Data streams: Algorithms and applications. Found. and Trends in Theoretical Computer Science, 1:117–236, 2 2005.

[16] John C. Platt. Using analytic QP and sparseness to speed training of support vector machines. In NIPS, pages 557–563, 1998.
[17] Bernhard Sch ¨olkopf and Alexander J. Smola. Learning with Kernels. The MIT Press, 2002.

0102040608010010−210−1100kStandardized MSE  THIS − HAVECRSApprox. Var0102040608010010−1100kStandardized MSE  ADDRESS − CUSTOMERCRSApprox. Var35101520253010−210−1100101kNormalized MSE  Dexter10%50%90%